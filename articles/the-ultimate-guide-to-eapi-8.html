<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<title>The ultimate guide to EAPI 8</title>
<meta name="author" content="Michał Górny" />
<meta name="dcterms.date" content="2021-06-17" />
<meta name="dcterms.rights" content="https://creativecommons.org/licenses/by/3.0/" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/"/>
<style type="text/css">

/* Minimal style sheet for the HTML output of Docutils.                    */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: minimal.css 8642 2021-03-26 13:51:14Z milde $               */
/* :Copyright: © 2015 Günter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */

/* This CSS2.1_ stylesheet defines rules for Docutils elements without    */
/* HTML equivalent. It is required to make the document semantic visible. */
/*                                                                        */
/* .. _CSS2.1: http://www.w3.org/TR/CSS2                                  */
/* .. _validates: http://jigsaw.w3.org/css-validator/validator$link       */

/* titles */
p.topic-title,
p.admonition-title,
p.system-message-title {
  font-weight: bold;
}
p.sidebar-title,
p.rubric {
  font-weight: bold;
  font-size: larger;
}
p.rubric {
  color: maroon;
}
p.subtitle,
p.section-subtitle,
p.sidebar-subtitle {
  font-weight: bold;
  margin-top: -0.5em;
}
h1 + p.subtitle {
  font-size: 1.6em;
}
h2 + p.section-subtitle, a.toc-backref {
  color: black;
  text-decoration: none;
}

/* Warnings, Errors */
.system-messages h2,
.system-message-title,
span.problematic {
  color: red;
}

/* Inline Literals */
.docutils.literal {
  font-family: monospace;
  white-space: pre-wrap;
}
/* do not wrap at hyphens and similar: */
.literal > span.pre { white-space: nowrap; }

/* Lists */

/* compact and simple lists: no margin between items */
.simple  li, .simple  ul, .simple  ol,
.compact li, .compact ul, .compact ol,
.simple  > li p, dl.simple  > dd,
.compact > li p, dl.compact > dd {
  margin-top: 0;
  margin-bottom: 0;
}
/* Nested Paragraphs */
p:first-child { margin-top: 0; }
p:last-child { margin-bottom: 0; }
td > p, th > p { margin-bottom: 0; }

/* Table of Contents */
.topic.contents { margin: 0.5em 0; }
.topic.contents ul.auto-toc {
  list-style-type: none;
  padding-left: 1.5em;
}

/* Enumerated Lists */
ol.arabic     { list-style: decimal }
ol.loweralpha { list-style: lower-alpha }
ol.upperalpha { list-style: upper-alpha }
ol.lowerroman { list-style: lower-roman }
ol.upperroman { list-style: upper-roman }

/* Definition Lists and Derivatives */
dt .classifier { font-style: italic }
dt .classifier:before {
  font-style: normal;
  margin: 0.5em;
  content: ":";
}
/* Field Lists and similar */
/* bold field name, content starts on the same line */
dl.field-list > dt,
dl.option-list > dt,
dl.docinfo > dt,
dl.footnote > dt,
dl.citation > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.5em;
}
/* Offset for field content (corresponds to the --field-name-limit option) */
dl.field-list > dd,
dl.option-list > dd,
dl.docinfo > dd {
  margin-left:  9em; /* ca. 14 chars in the test examples, fit all Docinfo fields */
}
/* start field-body on a new line after long field names */
dl.field-list > dd > *:first-child,
dl.option-list > dd > *:first-child
{
  display: inline-block;
  width: 100%;
  margin: 0;
}
/* field names followed by a colon */
dl.field-list > dt:after,
dl.docinfo > dt:after {
  content: ":";
}

/* Bibliographic Fields (docinfo) */
dl.docinfo pre.address {
  font: inherit;
  margin: 0.5em 0;
}
dl.docinfo > dd.authors > p { margin: 0; }

/* Option Lists */
dl.option-list > dt { font-weight: normal; }
span.option { white-space: nowrap; }

/* Footnotes and Citations  */
dl.footnote.superscript > dd { margin-left: 1em; }
dl.footnote.brackets > dd { margin-left: 2em; }
dl.footnote > dt { font-weight: normal; }
a.footnote-reference.brackets:before,
dt.label > span.brackets:before { content: "["; }
a.footnote-reference.brackets:after,
dt.label > span.brackets:after { content: "]"; }
a.footnote-reference.superscript,
dl.footnote.superscript > dt.label {
  vertical-align: super;
  font-size: small;
}
dt.label > span.fn-backref {
  margin-left: 0.2em;
  font-weight: normal;
}
dt.label > span.fn-backref > a { font-style: italic; }

/* Alignment */
.align-left   {
  text-align: left;
  margin-right: auto;
}
.align-center {
  clear: both;
  text-align: center;
  margin-left: auto;
  margin-right: auto;
}
.align-right  {
  text-align: right;
  margin-left: auto;
}
.align-top    { vertical-align: top; }
.align-middle { vertical-align: middle; }
.align-bottom { vertical-align: bottom; }

/* reset inner alignment in figures and tables */
figure.align-left, figure.align-right,
table.align-left, table.align-center, table.align-right {
  text-align: inherit;
}

/* Text Blocks */
blockquote,
div.topic,
aside.topic {
  margin: 1em 2em;
}
.sidebar,
.admonition,
.system-message {
  border: thin solid;
  margin: 1em 2em;
  padding: 0.5em 1em;
}
.sidebar {
  width: 30%;
  max-width: 26em;
  float: right;
  clear: right;
}
div.line-block { display: block; }
div.line-block div.line-block, pre { margin-left: 2em; }

/* Code line numbers: dropped when copying text from the page */
pre.code .ln { display: none; }
pre.code code:before {
  content: attr(data-lineno); /* …, none) fallback not supported by any browser */
  color: gray;
}

/* Tables */
table {
  border-collapse: collapse;
}
td, th {
  border: thin solid silver;
  padding: 0 1ex;
}
.borderless td, .borderless th {
  border: 0;
  padding: 0;
  padding-right: 0.5em /* separate table cells */
}

table > caption {
  text-align: left;
  margin-top: 0.2em;
  margin-bottom: 0.2em;
}
table.captionbelow {
  caption-side: bottom;
}

/* Document Header and Footer */
header { border-bottom: 1px solid black; }
footer { border-top: 1px solid black; }

/* Images are block-level by default in Docutils */
/* New HTML5 block elements: set display for older browsers */
img, header, section, footer, aside, nav, main, article, figure, video {
  display: block;
}
/* inline images */
p img, p video, figure img, figure video {
  display: inline;
}

</style>
<style type="text/css">

/* CSS31_ style sheet for the output of Docutils HTML writers.             */
/* Rules for easy reading and pre-defined style variants.                  */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: plain.css 8636 2021-03-19 00:23:33Z milde $                                                               */
/* :Copyright: © 2015 Günter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */
/* .. _CSS3: http://www.w3.org/TR/CSS3                                     */


/* Document Structure */
/* ****************** */

/* "page layout" */
body {
  margin: 0;
  background-color: #dbdbdb;
}
main, footer, header {
  line-height:1.3;
  /* avoid long lines --> better reading */
  /* optimum is 45…75 characters/line <http://webtypography.net/2.1.2> */
  /* OTOH: lines should not be too short because of missing hyphenation, */
  max-width: 50rem;
  padding: 1px 2%; /* 1px on top avoids grey bar above title (mozilla) */
  margin: auto;
}
main {
  counter-reset: table figure;
  background-color: white;
}
footer, header {
  font-size: smaller;
  padding: 0.5em 2%;
  border: none;
}

/* Transitions */
hr.docutils {
  width: 80%;
  margin-top: 1em;
  margin-bottom: 1em;
  clear: both;
}

/* Paragraphs */

/* vertical space (parskip) */
p, ol, ul, dl, li, dd,
div.line-block,
div.topic,
table {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}
p:first-child { margin-top: 0; }
/* (:last-child is new in CSS 3) */
p:last-child  { margin-bottom: 0; }

h1, h2, h3, h4, h5, h6,
dl > dd {
  margin-bottom: 0.5em;
}

/* Lists */
/* ===== */

/* Separate list entries in compound lists */
dl > dd, ol > li,

/* Definition Lists */
/* Indent lists nested in definition lists */
/* (:only-child is new in CSS 3)           */
dd > ul:only-child, dd > ol:only-child { padding-left: 1em; }

/* Description Lists */
/* styled like in most dictionaries, encyclopedias etc. */
dl.description > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.5em;
}

/* Field Lists */

/* example for custom field-name width */
dl.field-list.narrow > dd {
  margin-left: 5em;
}
/* run-in: start field-body on same line after long field names */
dl.field-list.run-in > dd p {
  display: block;
}

/* Bibliographic Fields */

/* generally, bibliographic fields use special definition list dl.docinfo */
/* but dedication and abstract are placed into "topic" divs */
div.abstract p.topic-title {
  text-align: center;
}
div.dedication {
  margin: 2em 5em;
  text-align: center;
  font-style: italic;
}
div.dedication p.topic-title {
  font-style: normal;
}

/* Text Blocks */
/* =========== */

/* Literal Blocks */
pre.literal-block, pre.doctest-block,
pre.math, pre.code {
  font-family: monospace;
}

/* Block Quotes */
blockquote > table,
div.topic > table {
  margin-top: 0;
  margin-bottom: 0;
}
blockquote p.attribution,
div.topic p.attribution {
  text-align: right;
  margin-left: 20%;
}

/* Tables */
/* ====== */

/* th { vertical-align: bottom; } */

table tr { text-align: left; }

/* "booktabs" style (no vertical lines) */
table.booktabs {
  border: 0;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.booktabs * {
  border: 0;
}
table.booktabs th {
  border-bottom: thin solid;
}

/* numbered tables (counter defined in div.document) */
table.numbered > caption:before {
  counter-increment: table;
  content: "Table " counter(table) ": ";
  font-weight: bold;
}

/* Explicit Markup Blocks */
/* ====================== */

/* Footnotes and Citations */
/* ----------------------- */

/* line on the left */
dl.footnote {
  padding-left: 1ex;
  border-left: solid;
  border-left-width: thin;
}

/* Directives */
/* ---------- */

/* Body Elements */
/* ~~~~~~~~~~~~~ */

/* Images and Figures */

/* let content flow to the side of aligned images and figures */
figure.align-left,
img.align-left,
video.align-left,
object.align-left {
  clear: left;
  float: left;
  margin-right: 1em;
}
figure.align-right,
img.align-right,
video.align-right,
object.align-right {
  clear: right;
  float: right;
  margin-left: 1em;
}
/* Stop floating sidebars, images and figures */
h1, h2, h3, h4, footer, header { clear: both; }

/* Numbered figures */
figure.numbered > figcaption > p:before {
  counter-increment: figure;
  content: "Figure " counter(figure) ": ";
  font-weight: bold;
}

/* Admonitions and System Messages */
.caution p.admonition-title,
.attention p.admonition-title,
.danger p.admonition-title,
.error p.admonition-title,
.warning p.admonition-title,
div.error {
  color: red;
}

/* Sidebar */
/* Move right. In a layout with fixed margins, */
/* it can be moved into the margin.            */
aside.sidebar {
  width: 30%;
  max-width: 26em;
  margin-left: 1em;
  margin-right: -2%;
  background-color: #ffffee;
}

/* Code */
pre.code { padding: 0.7ex }
pre.code, code { background-color: #eeeeee }
/* basic highlighting: for a complete scheme, see */
/* http://docutils.sourceforge.net/sandbox/stylesheets/ */
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

/* Math */
/* styled separately (see math.css for math-output=HTML) */

/* Epigraph           */
/* Highlights         */
/* Pull-Quote         */
/* Compound Paragraph */
/* Container          */

/* Inline Markup */
/* ============= */

/* Inline Literals                                          */
/* possible values: normal, nowrap, pre, pre-wrap, pre-line */
/*   span.docutils.literal { white-space: pre-wrap; }       */

/* Hyperlink References */
a { text-decoration: none; }

/* External Targets       */
/*   span.target.external */
/* Internal Targets       */
/*   span.target.internal */
/* Footnote References    */
/*   a.footnote-reference */
/* Citation References    */
/*   a.citation-reference */

</style>
</head>
<body class="with-toc">
<main id="the-ultimate-guide-to-eapi-8">
<h1 class="title">The ultimate guide to EAPI 8</h1>
<dl class="docinfo simple">
<dt class="author">Author</dt>
<dd class="author"><p>Michał Górny</p></dd>
<dt class="date">Date</dt>
<dd class="date">2021-06-17</dd>
<dt class="version">Version</dt>
<dd class="version">1.1</dd>
<dt class="copyright">Copyright</dt>
<dd class="copyright"><a class="reference external" href="https://creativecommons.org/licenses/by/3.0/">https://creativecommons.org/licenses/by/3.0/</a></dd>
<dt class="specification">Specification</dt>
<dd class="specification"><p><a class="reference external" href="https://projects.gentoo.org/pms/8/pms.html">https://projects.gentoo.org/pms/8/pms.html</a></p>
</dd>
</dl>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#preamble" id="id5">Preamble</a></p></li>
<li><p><a class="reference internal" href="#killer-features" id="id6">Killer features</a></p>
<ul>
<li><p><a class="reference internal" href="#install-time-dependencies-idepend" id="id7">Install-time dependencies (IDEPEND)</a></p></li>
<li><p><a class="reference internal" href="#selective-fetch-mirror-restriction" id="id8">Selective fetch/mirror restriction</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#minor-features" id="id9">Minor features</a></p>
<ul>
<li><p><a class="reference internal" href="#new-econf-passed-options" id="id10">New econf-passed options</a></p></li>
<li><p><a class="reference internal" href="#properties-and-restrict-are-now-accumulated-across-eclasses" id="id11">PROPERTIES and RESTRICT are now accumulated across eclasses</a></p></li>
<li><p><a class="reference internal" href="#dosym-r-to-create-relative-symlinks" id="id12">dosym -r to create relative symlinks</a></p></li>
<li><p><a class="reference internal" href="#usev-now-accepts-a-second-argument" id="id13">usev now accepts a second argument</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#other-changes" id="id14">Other changes</a></p>
<ul>
<li><p><a class="reference internal" href="#less-strict-naming-rules-for-updates-directory" id="id15">Less strict naming rules for updates directory</a></p></li>
<li><p><a class="reference internal" href="#bash-5-0-is-now-sanctioned" id="id16">Bash 5.0 is now sanctioned</a></p></li>
<li><p><a class="reference internal" href="#patches-src-prepare-variable-no-longer-permits-options" id="id17">PATCHES (src_prepare) variable no longer permits options</a></p></li>
<li><p><a class="reference internal" href="#insopts-and-exeopts-now-apply-to-doins-and-doexe-only" id="id18">insopts and exeopts now apply to doins and doexe only</a></p></li>
<li><p><a class="reference internal" href="#pkg-phases-now-run-in-a-dedicated-empty-directory" id="id19">pkg_* phases now run in a dedicated empty directory</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#bans-and-removals" id="id20">Bans and removals</a></p>
<ul>
<li><p><a class="reference internal" href="#hasq-hasv-and-useq-functions-have-been-banned" id="id21">hasq, hasv and useq functions have been banned</a></p></li>
<li><p><a class="reference internal" href="#unpack-removes-support-for-7-zip-lha-and-rar-formats" id="id22">unpack removes support for 7-Zip, LHA and RAR formats</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#retroactive-changes" id="id23">Retroactive changes</a></p>
<ul>
<li><p><a class="reference internal" href="#properties-test-network-to-ease-reenabling-tests-requiring-internet" id="id24">PROPERTIES=test_network to ease reenabling tests requiring Internet</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cheat-sheet-index" id="id25">Cheat sheet / index</a></p></li>
<li><p><a class="reference internal" href="#references" id="id26">References</a></p></li>
</ul>
</div>
<section id="preamble">
<h2><a class="toc-backref" href="#id5">Preamble</a></h2>
<p>Three years ago, I had the pleasure of announcing EAPI 7 as a major step
forward in our ebuild language.  It introduced preliminary support for
cross-compilation, it finally provided good replacements for the last
Portagisms in ebuilds and it included many small changes that made
ebuilds simpler.</p>
<p>Only a year and a half later, I have started working on the initial
EAPI 8 feature set.  Similarly to EAPI 6, EAPI 8 was supposed to focus
on small changes and improvements.  The two killer features listed
below were already proposed at the time.  I have prepared a few patches
to the specification, as well as the initial implementation
of the respective features for Portage.  Unfortunately, the work stalled
at the time.</p>
<p>Finally, as a result of surplus of free time last month, I was able
to resume the work.  Along with Ulrich Müller, we have quickly prepared
the EAPI 8 feature set, got it pre-approved, prepared the specification
and implemented all the features in Portage and pkgcore.  Last Sunday,
the Council has approved EAPI 8 and it's now ready for <span class="docutils literal">~arch</span> use.</p>
<p>What's there in EAPI 8?  Well, for a start we have <a class="reference internal" href="#install-time-dependencies-idepend">install-time
dependencies (IDEPEND)</a> that fill a gap in our cross-compilation
design.  Then, <a class="reference internal" href="#selective-fetch-mirror-restriction">selective fetch/mirror restriction</a> make it easier
to combine proprietary and free distfiles in a single package.
<a class="reference internal" href="#properties-and-restrict-are-now-accumulated-across-eclasses">PROPERTIES and RESTRICT are now accumulated across eclasses</a> reducing
confusion for eclass writers.  There's <a class="reference internal" href="#dosym-r-to-create-relative-symlinks">dosym -r to create relative
symlinks</a> conveniently from dynamic paths.  Plus bunch of other
improvements, updates and cleanups.</p>
</section>
<section id="killer-features">
<h2><a class="toc-backref" href="#id6">Killer features</a></h2>
<section id="install-time-dependencies-idepend">
<span id="idepend"></span><h3><a class="toc-backref" href="#id7">Install-time dependencies (IDEPEND)</a></h3>
<pre class="code bash literal-block"><code><span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">8</span>
inherit xdg-utils

<span class="name variable">IDEPEND</span><span class="operator">=</span><span class="literal string double">&quot;dev-util/desktop-file-utils&quot;</span>

pkg_postinst<span class="operator">()</span> <span class="operator">{</span>
    xdg_desktop_database_update
<span class="operator">}</span>

pkg_postrm<span class="operator">()</span> <span class="operator">{</span>
    xdg_desktop_database_update
<span class="operator">}</span></code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>TL;DR: <span class="docutils literal">IDEPEND</span> specifies programs that you execute during
<span class="docutils literal">pkg_preinst</span>, <span class="docutils literal">pkg_postinst</span>, <span class="docutils literal">pkg_prerm</span> and <span class="docutils literal">pkg_postrm</span>.</p>
</div>
<p>Install-time dependencies are not a new idea.  It has been on the board
for quite some time already but we never had a compelling reason
to implement it.  The primary use case was to specify dependencies that
are needed during <span class="docutils literal">pkg_postinst</span> phase and that can be unmerged
afterwards.  That's pretty much the same as <span class="docutils literal">RDEPEND</span>, except for
the unmerging part — and uninstalling a few tools did not seem a goal
justifying another dependency type.</p>
<p>EAPI 7 changed that.  With cross-compilation support, we have added
a new dependency type focused on the build host (<span class="docutils literal">CBUILD</span>) tools —
<span class="docutils literal">BDEPEND</span>.  Unfortunately, once we started porting ebuilds it has
finally occurred to me that we have missed one important use case.  We
could not run executables installed to the target system when
cross-compiling!  <span class="docutils literal">RDEPEND</span> was no longer a suitable method of pulling
in tools for <span class="docutils literal">pkg_postinst</span>; and since <span class="docutils literal">BDEPEND</span> is not used when
installing from a binary package, we needed something new.</p>
<p>This is where <span class="docutils literal">IDEPEND</span> comes.  It is roughly to <span class="docutils literal">RDEPEND</span> what
<span class="docutils literal">BDEPEND</span> is to <span class="docutils literal">DEPEND</span>.  Similarly to <span class="docutils literal">BDEPEND</span>, it specifies
packages that must be built for <span class="docutils literal">CBUILD</span> triplet and installed into
<span class="docutils literal">BROOT</span> (and therefore queried using <span class="docutils literal">has_version <span class="pre">-b</span></span>).  However,
alike <span class="docutils literal">RDEPEND</span>, it is used when the package is being merged rather
than built from source.  It is guaranteed to be satisfied throughout
<span class="docutils literal">pkg_preinst</span> and <span class="docutils literal">pkg_postinst</span>, and it can be uninstalled
afterwards.</p>
<p>In the example provided above, the ebuild needs to be update the icon
cache upon being installed or uninstalled.  By placing the respective
tool in <span class="docutils literal">IDEPEND</span>, the ebuild requests it to be available at the time
of <span class="docutils literal">pkg_postinst</span>.  When cross-compiling, the tool will be built
for <span class="docutils literal">CBUILD</span> and therefore directly executable by the ebuild.</p>
<p>The dependency types table for EAPI 8 is presented below.</p>
<blockquote>
<table>
<colgroup>
<col style="width: 41%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 13%" />
<col style="width: 11%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr><th class="head"><p>Dependency type</p></th>
<th class="head"><p>BDEPEND</p></th>
<th class="head"><p>IDEPEND</p></th>
<th class="head"><p>DEPEND</p></th>
<th class="head"><p>RDEPEND</p></th>
<th class="head"><p>PDEPEND</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>Present at</p></td>
<td><p>build</p></td>
<td><p>install</p></td>
<td><p>build</p></td>
<td><p>install</p></td>
<td><p>n/a</p></td>
</tr>
<tr><td><p>Binary compatible with</p></td>
<td colspan="2"><p>CBUILD</p></td>
<td colspan="3"><p>CHOST</p></td>
</tr>
<tr><td><p>Base unprefixed path</p></td>
<td colspan="2"><p><span class="docutils literal">/</span></p></td>
<td><p>SYSROOT</p></td>
<td colspan="2"><p>ROOT</p></td>
</tr>
<tr><td><p>Relevant offset-prefix</p></td>
<td colspan="2"><p>BROOT</p></td>
<td><p>(*)</p></td>
<td colspan="2"><p>EPREFIX</p></td>
</tr>
<tr><td><p>Path combined with prefix</p></td>
<td colspan="2"><p>BROOT</p></td>
<td><p>ESYSROOT</p></td>
<td colspan="2"><p>EROOT</p></td>
</tr>
<tr><td><p>PM query command option</p></td>
<td colspan="2"><p><span class="docutils literal"><span class="pre">-b</span></span></p></td>
<td><p><span class="docutils literal"><span class="pre">-d</span></span></p></td>
<td colspan="2"><p><span class="docutils literal"><span class="pre">-r</span></span></p></td>
</tr>
</tbody>
</table>
</blockquote>
<p>(*) The offset-prefix applicable to <span class="docutils literal">DEPEND</span> depends on the values
of <span class="docutils literal">ROOT</span> and <span class="docutils literal">SYSROOT</span>.  This is explained in detail in the EAPI 7
Guide.</p>
</section>
<section id="selective-fetch-mirror-restriction">
<span id="mirror"></span><span id="fetch"></span><h3><a class="toc-backref" href="#id8">Selective fetch/mirror restriction</a></h3>
<pre class="code bash literal-block"><code><span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">8</span>

<span class="name variable">SRC_URI</span><span class="operator">=</span><span class="literal string double">&quot;
    </span><span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span><span class="literal string double">.tgz
    fetch+https://example.com/</span><span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span><span class="literal string double">-patch-1.tgz
    mirror+https://example.com/</span><span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span><span class="literal string double">-fanstuff.tgz&quot;</span>

<span class="name variable">RESTRICT</span><span class="operator">=</span><span class="literal string double">&quot;fetch&quot;</span></code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>TL;DR: <span class="docutils literal">fetch+</span> and <span class="docutils literal">mirror+</span> prefixes can now be used
in <span class="docutils literal">SRC_URI</span> to lift respective restrictions.</p>
</div>
<p>Before EAPI 8, fetch and mirror restrictions applied globally.  That is,
if you needed to apply the respective restriction to at least one
distfile, you had to apply it to them all.  However, sometimes packages
used a combination of proprietary and free distfiles, the latter
including e.g. third party patches, artwork.  We had to mirror-restrict
them so far.</p>
<p>EAPI 8 brings the possibility of undoing fetch and mirror restriction
for individual files.  The rough idea is that you put a <span class="docutils literal">RESTRICT</span>
as before, then use special <span class="docutils literal">fetch+</span> prefix to specify URLs that can
be fetched from, or <span class="docutils literal">mirror+</span> prefix to reenable mirroring
of individual files.</p>
<p>Similarly to how <span class="docutils literal">fetch</span> restriction implies <span class="docutils literal">mirror</span> restriction,
<span class="docutils literal">mirror</span> override implies <span class="docutils literal">fetch</span> override.  This might sound
confusing at first but when you think about it, it's perfectly logical.</p>
<p>The following table summarizes it.</p>
<blockquote>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 33%" />
<col style="width: 24%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr><th class="head"><p>RESTRICT</p></th>
<th class="head"><p>URI prefix</p></th>
<th class="head"><p>Fetching</p></th>
<th class="head"><p>Mirroring</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>(none)</p></td>
<td><p>(any)</p></td>
<td><p>allowed</p></td>
<td><p>allowed</p></td>
</tr>
<tr><td rowspan="2"><p>mirror</p></td>
<td><p>(none) / fetch+</p></td>
<td><p>allowed</p></td>
<td><p>prohibited</p></td>
</tr>
<tr><td><p>mirror+</p></td>
<td><p>allowed</p></td>
<td><p>allowed</p></td>
</tr>
<tr><td rowspan="3"><p>fetch</p></td>
<td><p>(none)</p></td>
<td><p>prohibited</p></td>
<td><p>prohibited</p></td>
</tr>
<tr><td><p>fetch+</p></td>
<td><p>allowed</p></td>
<td><p>prohibited</p></td>
</tr>
<tr><td><p>mirror+</p></td>
<td><p>allowed</p></td>
<td><p>allowed</p></td>
</tr>
</tbody>
</table>
</blockquote>
</section>
</section>
<section id="minor-features">
<h2><a class="toc-backref" href="#id9">Minor features</a></h2>
<section id="new-econf-passed-options">
<span id="disable-static"></span><span id="datarootdir"></span><h3><a class="toc-backref" href="#id10">New econf-passed options</a></h3>
<p>The <span class="docutils literal">econf</span> helper has been modified to pass two more options
to the configure script if the <span class="docutils literal"><span class="pre">--help</span></span> text indicates that they are
supported.  These are:</p>
<ul class="simple">
<li><p><span class="docutils literal"><span class="pre">--datarootdir=&quot;${EPREFIX}&quot;/usr/share</span></span></p></li>
<li><p><span class="docutils literal"><span class="pre">--disable-static</span></span></p></li>
</ul>
<p>The former option defines the base directory that is used to determine
locations for system/desktop-specific data files, e.g. .desktop files
and various kinds of documentation.  This is necessary for ebuilds that
override <span class="docutils literal"><span class="pre">--prefix</span></span>, as the default path is relative to it.</p>
<p>The latter option disables building static libraries by default.  This
is part of the ongoing effort to disable unconditional install of static
libraries.  <a class="footnote-reference brackets" href="#qa-policy-static" id="id1">1</a></p>
</section>
<section id="properties-and-restrict-are-now-accumulated-across-eclasses">
<span id="restrict"></span><span id="properties"></span><h3><a class="toc-backref" href="#id11">PROPERTIES and RESTRICT are now accumulated across eclasses</a></h3>
<p>Up to EAPI 7, <span class="docutils literal">PROPERTIES</span> and <span class="docutils literal">RESTRICT</span> were treated like regular
bash variables when sourcing eclasses.  This meant that if an eclass
or an ebuild wanted to modify them, they had to explicitly append
to them, e.g.  via <span class="docutils literal">+=</span>.  This was inconsistent with how some other
variables (but not all) were handled, and confusing to developers.
For example, consider the following snippet:</p>
<pre class="code bash literal-block"><code><span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">7</span>

inherit git-r3

<span class="name variable">PROPERTIES</span><span class="operator">+=</span><span class="literal string double">&quot; interactive&quot;</span></code></pre>
<p>Note how you needed to append to <span class="docutils literal">PROPERTIES</span> set by git-r3 eclass,
otherwise the ebuild would have overwritten it.  In EAPI 8, you can
finally do the following instead:</p>
<pre class="code bash literal-block"><code><span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">8</span>

inherit git-r3

<span class="name variable">PROPERTIES</span><span class="operator">=</span><span class="literal string double">&quot;interactive&quot;</span></code></pre>
<p>Now the complete list of metadata variables accumulated across eclasses
and ebuilds includes: <span class="docutils literal">IUSE</span>, <span class="docutils literal">REQUIRED_USE</span>, <span class="docutils literal">*DEPEND</span>,
<span class="docutils literal">PROPERTIES</span>, <span class="docutils literal">RESTRICT</span>.  Variables that are not treated this way
are: <span class="docutils literal">EAPI</span>, <span class="docutils literal">HOMEPAGE</span>, <span class="docutils literal">SRC_URI</span>, <span class="docutils literal">LICENSE</span>, <span class="docutils literal">KEYWORDS</span>.
<span class="docutils literal">EAPI</span> and <span class="docutils literal">KEYWORDS</span> are not supposed to be set in eclasses; as for
the others, we have decided that there is a valid use case for eclasses
providing default values and the ebuilds being able to override them.</p>
</section>
<section id="dosym-r-to-create-relative-symlinks">
<span id="dosym-r"></span><h3><a class="toc-backref" href="#id12">dosym -r to create relative symlinks</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>TL;DR: <span class="docutils literal"><span class="pre">-r</span></span> now can be used to have dosym figure out the correct
relative path from symlink to target.</p>
</div>
<p>We have been pushing for relative symlink targets for some time now,
as they are more reliable.  Consider the two following examples:</p>
<pre class="code bash literal-block"><code>dosym <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">EPREFIX</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>/usr/lib/frobnicate/frobnicate /usr/bin/frobnicate
dosym ../lib/frobnicate/frobnicate /usr/bin/frobnicate</code></pre>
<p>The first line creates a symlink using absolute path.  The big deal with
that is if you mount your Gentoo system in a subdirectory of your root
filesystem (e.g. for recovery), the symlink will point at the wrong
path!  Using relative symlinks (as demonstrated on the second line)
guarantees that the symlink will work independently of where
the filesystem is mounted.</p>
<p>There is also the less known fact that <span class="docutils literal">dosym</span> has historically
prepended <span class="docutils literal">EPREFIX</span> to the absolute paths passed as the first
argument, that had the side effect of making it impossible to create
symlinks pointing outside the offset prefix (e.g. into <span class="docutils literal">/dev</span> or
<span class="docutils literal">/proc</span>).  This is no longer the case, and now you need to prepend
<span class="docutils literal">${EPREFIX}</span> explicitly.  Using relative target avoids the problem
altogether and makes it less likely for you to forget about the prefix.</p>
<p>However, in some instances determining the relative path could be hard
or inconvenient.  This is especially the case if one (or both)
of the paths comes from an external tool.  To make it easier, EAPI 8
adds a new <span class="docutils literal"><span class="pre">-r</span></span> option that makes <span class="docutils literal">dosym</span> create a relative symlink
to the specified path (similarly to <span class="docutils literal">ln <span class="pre">-r</span></span>):</p>
<pre class="code bash literal-block"><code>dosym -r /usr/lib/frobnicate/frobnicate /usr/bin/frobnicate</code></pre>
<p>Note that in this case, you do not pass <span class="docutils literal">${EPREFIX}</span>.  The helper
determines the <em>logical</em> relative path to the first argument and creates
the appropriate relative symlink.  It is very important here to
understand that this function does not handle physical paths, i.e. it
will work only if there are no directory symlinks along the way that
would result in <span class="docutils literal">..</span> resolving to a different path.  For example,
the following will not work:</p>
<pre class="code bash literal-block"><code>dosym bar/foo /usr/lib/foo
dosym -r /usr/lib/zomg /usr/lib/foo/zomg</code></pre>
<p>The logical path from <span class="docutils literal">/usr/lib/foo/zomg</span> to <span class="docutils literal">/usr/lib/zomg</span>
is <span class="docutils literal"><span class="pre">../zomg</span></span>.  However, since <span class="docutils literal">/usr/lib/foo</span> is actually a symlink
to <span class="docutils literal">/usr/lib/bar/foo</span>, <span class="docutils literal"><span class="pre">/usr/lib/foo/..</span></span> resolves
to <span class="docutils literal">/usr/lib/bar</span>.  If you need to account for such directory
symlinks, you need to specify the correct path explicitly:</p>
<pre class="code bash literal-block"><code>dosym bar/foo /usr/lib/foo
dosym ../../zomg /usr/lib/foo/zomg</code></pre>
</section>
<section id="usev-now-accepts-a-second-argument">
<span id="usev"></span><h3><a class="toc-backref" href="#id13">usev now accepts a second argument</a></h3>
<p>The <span class="docutils literal">usev</span> helper has been introduced to provide the historical
Portage behavior of outputting the USE flag name on match.  In EAPI 8,
we have decided to extend it, in order to provide an alternative
to three-argument <span class="docutils literal">usex</span> with an empty third argument
(the two-argument variant uses a default of <span class="docutils literal">no</span> for the false
branch).</p>
<p>In other words, the following two calls are now equivalent:</p>
<pre class="code bash literal-block"><code><span class="keyword">$(</span>usex foo --enable-foo <span class="literal string single">''</span><span class="keyword">)</span>
<span class="keyword">$(</span>usev foo --enable-foo<span class="keyword">)</span></code></pre>
<p>This is particularly useful with custom build systems that accept
individual <span class="docutils literal"><span class="pre">--enable</span></span> or <span class="docutils literal"><span class="pre">--disable</span></span> options but not their
counterparts.</p>
<p>As a result, <span class="docutils literal">usev</span> and <span class="docutils literal">usex</span> can now be used to achieve all
the common (and less common) output needs as summarized in the following
table.</p>
<blockquote>
<table>
<colgroup>
<col style="width: 65%" />
<col style="width: 17%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr><th class="head"><p>Variant</p></th>
<th class="head"><p>True</p></th>
<th class="head"><p>False</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>usev <em>flag</em></p></td>
<td><p><em>flag</em></p></td>
<td></td>
</tr>
<tr><td><p>usev <em>flag</em> <em>true</em></p></td>
<td><p><em>true</em></p></td>
<td></td>
</tr>
<tr><td><p>usex <em>flag</em></p></td>
<td><p><span class="docutils literal">yes</span></p></td>
<td><p><span class="docutils literal">no</span></p></td>
</tr>
<tr><td><p>usex <em>flag</em> <em>true</em></p></td>
<td><p><em>true</em></p></td>
<td><p><span class="docutils literal">no</span></p></td>
</tr>
<tr><td><p>usex <em>flag</em> <em>true</em> <em>false</em></p></td>
<td><p><em>true</em></p></td>
<td><p><em>false</em></p></td>
</tr>
</tbody>
</table>
</blockquote>
</section>
</section>
<section id="other-changes">
<h2><a class="toc-backref" href="#id14">Other changes</a></h2>
<section id="less-strict-naming-rules-for-updates-directory">
<span id="updates"></span><h3><a class="toc-backref" href="#id15">Less strict naming rules for updates directory</a></h3>
<p>Up to EAPI 7, the files in <span class="docutils literal">profiles/updates</span> directory had to follow
the naming scheme of <span class="docutils literal"><span class="pre">nQ-yyyy</span></span>, indicating the quarter and the year
when they were added.  Such a choice of name had the side effect that
lexical sorting of filenames was quite inconvenient.</p>
<p>In EAPI 8, the naming requirement is removed.  Eventually, this will
permit us to switch to a more convenient scheme sorted by the year,
as well as split into different lengths of periods in the future, as we
see fit.</p>
<p>Note that this change actually requires changing the repository EAPI
(found in <span class="docutils literal">profiles/eapi</span>), so it will not really affect Gentoo for
the next two years.</p>
</section>
<section id="bash-5-0-is-now-sanctioned">
<span id="bash"></span><h3><a class="toc-backref" href="#id16">Bash 5.0 is now sanctioned</a></h3>
<p>As of EAPI 8, the bash version used for ebuilds is changed from 4.2
to 5.0.  This means not only that ebuilds are now permitted to use
features provided by the new bash version but also the <span class="docutils literal">BASH_COMPAT</span>
value used for ebuild environment is updated, switching the shell
behavior.</p>
<p>The only really relevant difference in behavior is:</p>
<ul>
<li><p>Quotes are now removed from RHS argument of <span class="docutils literal"><span class="pre">&quot;${var/.../&quot;...&quot;}&quot;</span></span>
substitution:</p>
<pre class="code bash literal-block"><code><span class="name variable">var</span><span class="operator">=</span>foo
<span class="name builtin">echo</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">var</span><span class="punctuation">/foo/</span><span class="literal string double">&quot;bar&quot;</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span></code></pre>
<p>The above snippet yields <span class="docutils literal">&quot;bar&quot;</span> in bash 4.2 but just <span class="docutils literal">bar</span>
in 4.3+.</p>
</li>
</ul>
<p>Potentially interesting new features include:</p>
<ul>
<li><p>Negative subscripts can now be used to set and unset array elements
(bash 4.3+):</p>
<pre class="code bash literal-block"><code>$ <span class="name variable">foo</span><span class="operator">=(</span> <span class="literal number">1</span> <span class="literal number">2</span> <span class="literal number">3</span> <span class="operator">)</span>
$ foo<span class="operator">[</span>-1<span class="operator">]=</span><span class="literal number">4</span>
$ <span class="name builtin">unset</span> <span class="literal string single">'foo[-2]'</span>
$ <span class="name builtin">declare</span> -p foo
<span class="name builtin">declare</span> -a <span class="name variable">foo</span><span class="operator">=([</span><span class="literal number">0</span><span class="operator">]=</span><span class="literal string double">&quot;1&quot;</span> <span class="operator">[</span><span class="literal number">2</span><span class="operator">]=</span><span class="literal string double">&quot;4&quot;</span><span class="operator">)</span></code></pre>
</li>
<li><p>Nameref variables are introduced that work as references to other
variables (4.3+):</p>
<pre class="code bash literal-block"><code>$ <span class="name variable">foo</span><span class="operator">=(</span> <span class="literal number">1</span> <span class="literal number">2</span> <span class="literal number">3</span> <span class="operator">)</span>
$ <span class="name builtin">declare</span> -n <span class="name variable">bar</span><span class="operator">=</span>foo
$ <span class="name builtin">echo</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">bar</span><span class="punctuation">[&#64;]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>
<span class="literal number">1</span> <span class="literal number">2</span> <span class="literal number">3</span>
$ bar<span class="operator">[</span><span class="literal number">0</span><span class="operator">]=</span><span class="literal number">4</span>
$ <span class="name builtin">echo</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">foo</span><span class="punctuation">[&#64;]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>
<span class="literal number">4</span> <span class="literal number">2</span> <span class="literal number">3</span>
$ <span class="name builtin">declare</span> -n <span class="name variable">baz</span><span class="operator">=</span>foo<span class="operator">[</span><span class="literal number">1</span><span class="operator">]</span>
$ <span class="name builtin">echo</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">baz</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>
<span class="literal number">2</span>
$ <span class="name variable">baz</span><span class="operator">=</span><span class="literal number">100</span>
$ <span class="name builtin">echo</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">bar</span><span class="punctuation">[&#64;]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>
<span class="literal number">4</span> <span class="literal number">100</span> <span class="literal number">3</span></code></pre>
</li>
<li><p><span class="docutils literal">[[ <span class="pre">-v</span> ... ]]</span> test operator can be used with array indices to test
for array elements being set (4.3+).  The two following lines are now
equivalent:</p>
<pre class="code bash literal-block"><code><span class="operator">[[</span> -n <span class="literal string interpol">${</span><span class="name variable">foo</span><span class="punctuation">[3]+1</span><span class="literal string interpol">}</span> <span class="operator">]]</span>
<span class="operator">[[</span> -v foo<span class="operator">[</span><span class="literal number">3</span><span class="operator">]</span> <span class="operator">]]</span></code></pre>
</li>
<li><p><span class="docutils literal">mapfile</span> (AKA <span class="docutils literal">readarray</span>) now accepts a delimiter via <span class="docutils literal"><span class="pre">-d</span></span>,
with a <span class="docutils literal"><span class="pre">-t</span></span> option to strip it from read data (bash 4.4+).  The two
following solutions to grab output from <span class="docutils literal">find(1)</span> are now
equivalent:</p>
<pre class="code bash literal-block"><code><span class="comment single"># old solution
</span><span class="name builtin">local</span> x <span class="name variable">files</span><span class="operator">=()</span>
<span class="keyword">while</span> <span class="name builtin">read</span> -d <span class="literal string single">''</span> -r x<span class="punctuation">;</span> <span class="keyword">do</span>
    <span class="name variable">files</span><span class="operator">+=(</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">x</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span> <span class="operator">)</span>
<span class="keyword">done</span> &lt; &lt;<span class="operator">(</span>find -print0<span class="operator">)</span>

<span class="comment single"># new solution
</span><span class="name builtin">local</span> <span class="name variable">files</span><span class="operator">=()</span>
mapfile -d <span class="literal string single">''</span> -t files &lt; &lt;<span class="operator">(</span>find -print0<span class="operator">)</span></code></pre>
</li>
<li><p>A new set of transformations is available via <span class="docutils literal"><span class="pre">${foo&#64;...}</span></span> parameter
expansion (4.4+), e.g. to print a value with necessary quoting:</p>
<pre class="code bash literal-block"><code>$ <span class="name variable">var</span><span class="operator">=</span><span class="literal string double">&quot;foo 'bar' baz&quot;</span>
$ <span class="name builtin">echo</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">var</span><span class="punctuation">&#64;Q</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>
<span class="literal string single">'foo '</span><span class="literal string escape">\'</span><span class="literal string single">'bar'</span><span class="literal string escape">\'</span><span class="literal string single">' baz'</span></code></pre>
<p>For more details, see: <span class="docutils literal">info bash</span> <a class="footnote-reference brackets" href="#bash-expansion" id="id2">2</a>.</p>
</li>
<li><p><span class="docutils literal">local -</span> can be used to limit single-letter (mangled via <span class="docutils literal">set</span>)
shell option changes to the scope of the function, and restore them
upon returning from it (4.4+).  The following two functions are now
equivalent:</p>
<pre class="code bash literal-block"><code><span class="comment single"># old solution
</span>func<span class="operator">()</span> <span class="operator">{</span>
    <span class="name builtin">local</span> <span class="name variable">prev_shopt</span><span class="operator">=</span><span class="keyword">$(</span><span class="name builtin">shopt</span> -p -o noglob<span class="keyword">)</span>
    <span class="name builtin">set</span> -o noglob
    <span class="literal string interpol">${</span><span class="name variable">prev_shopt</span><span class="literal string interpol">}</span>
<span class="operator">}</span>

<span class="comment single"># new solution
</span>func<span class="operator">()</span> <span class="operator">{</span>
    <span class="name builtin">local</span> -
    <span class="name builtin">set</span> -o noglob
<span class="operator">}</span></code></pre>
</li>
</ul>
<p>The complete information on all changes and new features can be found
in the release notes <a class="footnote-reference brackets" href="#bash-news" id="id3">3</a>.</p>
</section>
<section id="patches-src-prepare-variable-no-longer-permits-options">
<span id="patches"></span><h3><a class="toc-backref" href="#id17">PATCHES (src_prepare) variable no longer permits options</a></h3>
<p>The <span class="docutils literal">eapply</span> invocation in the default <span class="docutils literal">src_prepare</span> implementation
has been changed from the equivalent of:</p>
<pre class="code bash literal-block"><code>eapply <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">PATCHES</span><span class="punctuation">[&#64;]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span></code></pre>
<p>to:</p>
<pre class="code bash literal-block"><code>eapply -- <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">PATCHES</span><span class="punctuation">[&#64;]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span></code></pre>
<p>This ensures that all items in the <span class="docutils literal">PATCHES</span> variable are treated
as path names.  As a side effect, it is no longer possible to specify
<span class="docutils literal">patch</span> options via the <span class="docutils literal">PATCHES</span> variable.  Such hacks were never
used in ::gentoo but they have been spotted in user-contributed ebuilds.
The following will no longer work:</p>
<pre class="code bash literal-block"><code><span class="name variable">PATCHES</span><span class="operator">=(</span> -p0 <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">FILESDIR</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>/<span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span>-foo.patch <span class="operator">)</span></code></pre>
<p>Instead, you will need to invoke <span class="docutils literal">eapply</span> explicitly, i.e.:</p>
<pre class="code bash literal-block"><code>src_prepare<span class="operator">()</span> <span class="operator">{</span>
    eapply -p0 <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">FILESDIR</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>/<span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span>-foo.patch
    eapply_user
<span class="operator">}</span></code></pre>
</section>
<section id="insopts-and-exeopts-now-apply-to-doins-and-doexe-only">
<span id="doinitd"></span><span id="doheader"></span><span id="doenvd"></span><span id="doconfd"></span><h3><a class="toc-backref" href="#id18">insopts and exeopts now apply to doins and doexe only</a></h3>
<p>We have noticed some inconsistency in how <span class="docutils literal">insopts</span> and <span class="docutils literal">exeopts</span>
apply to various helpers in EAPI 7.  In particular, the majority
of helpers (e.g. <span class="docutils literal">dobin</span>, <span class="docutils literal">dodoc</span> and so on) ignored the options
specified via these helpers but a few did not.</p>
<p>In EAPI 8, we have changed the behavior of the following helpers that
used to respect <span class="docutils literal">insopts</span> or <span class="docutils literal">exeopts</span>:</p>
<ul class="simple">
<li><p><span class="docutils literal">doconfd</span></p></li>
<li><p><span class="docutils literal">doenvd</span></p></li>
<li><p><span class="docutils literal">doheader</span></p></li>
<li><p><span class="docutils literal">doinitd</span></p></li>
</ul>
<p>In EAPI 8, they always use the default options.  As a result,
<span class="docutils literal">insopts</span> now only affects <span class="docutils literal">doins</span>/<span class="docutils literal">newins</span>, and <span class="docutils literal">exeopts</span> only
affects <span class="docutils literal">doexe</span>/<span class="docutils literal">newexe</span>.  Furthermore, <span class="docutils literal">diropts</span> do not affect
the directories implicitly created by these helpers.</p>
</section>
<section id="pkg-phases-now-run-in-a-dedicated-empty-directory">
<span id="working-directory"></span><h3><a class="toc-backref" href="#id19">pkg_* phases now run in a dedicated empty directory</a></h3>
<p>Before EAPI 8, the initial working directory was specified for <span class="docutils literal">src_*</span>
phases only.  For other phases (i.e. <span class="docutils literal">pkg_*</span> phases), ebuilds were not
supposed to assume any particular directory.  In EAPI 8, these phases
are guaranteed to be started in a dedicated empty directory.</p>
<p>The problem with unspecified working directory dates back to 2016.
At the time, Portage defaulted to running these phases
in <span class="docutils literal">PORTAGE_PYM_PATH</span>, i.e. the directory containing Portage's Python
modules, usually the <span class="docutils literal"><span class="pre">site-packages</span></span> directory of the Python
interpreter used.  However, since Python's default search path starts
with the current directory, it meant that various Python scripts were
importing modules from this directory, possibly using modules
for the <em>wrong</em> Python interpreter.</p>
<p>This was originally reported as a <span class="docutils literal">pkg_preinst</span> failure
in <span class="docutils literal"><span class="pre">dev-python/packaging</span></span>.  Long story short, the reporter has been
using Python 2.7 as the system Python.  When the preinst phase run code
using Python 3, it mistakenly ended up loading packages from
the site-packages directory of Python 2.7, and this particular package
did not like it.  <a class="footnote-reference brackets" href="#packaging-preinst-fail" id="id4">4</a></p>
<p>Now, technically the fault was in the ebuild.  After all, PMS specified
that ebuilds must not rely upon any particular directory.  However,
it is rather unpractical to try to predict all the possible interactions
between tools run in these phases and arbitrary working directories.</p>
<p>At the time, Portage was modified to prefer using the temporary <span class="docutils literal">HOME</span>
directory created for the package, if available.  This pretty much meant
sweeping the problem under the rug.  EAPI 8 finally comes with
a permanent (we hope!) solution.</p>
<p>The idea of using an empty directory is pretty simple — if there are
no files in it, the risk of unexpected and hard to predict interactions
is minimalized.  It certainly is not a solution to all possible problems
but it should be good enough.</p>
</section>
</section>
<section id="bans-and-removals">
<h2><a class="toc-backref" href="#id20">Bans and removals</a></h2>
<section id="hasq-hasv-and-useq-functions-have-been-banned">
<span id="useq"></span><span id="hasv"></span><span id="hasq"></span><h3><a class="toc-backref" href="#id21">hasq, hasv and useq functions have been banned</a></h3>
<p>If you look at some early Gentoo ebuilds, you can find little monsters
like the following:</p>
<pre class="code bash literal-block"><code><span class="keyword">if</span> <span class="operator">[</span> -n <span class="literal string double">&quot;`use gnome`&quot;</span> <span class="operator">]</span>
<span class="keyword">then</span>
    ./configure --host<span class="operator">=</span><span class="literal string interpol">${</span><span class="name variable">CHOST</span><span class="literal string interpol">}</span> --enable-gnome --disable perl --prefix<span class="operator">=</span>/opt/gnome --with-catgets
<span class="keyword">else</span>
    ./configure --host<span class="operator">=</span><span class="literal string interpol">${</span><span class="name variable">CHOST</span><span class="literal string interpol">}</span> --disable-gnome --disable-perl --prefix<span class="operator">=</span>/usr/X11R6 --with-catgets
<span class="keyword">fi</span></code></pre>
<p>This is because in its early days, the <span class="docutils literal">use</span> helper did not return
a boolean value as exit status.  Instead, it printed the USE flag name
if it matched, and did not print anything if it did not.  So checking
for non-empty output was the thing.</p>
<p>In 2001, the boolean exit status was added to <span class="docutils literal">use</span> but the output
remained.  In 2004, <span class="docutils literal">use</span> was modified to output only when connected
to a tty.  However, that change was reverted shortly afterwards
and instead the quiet <span class="docutils literal">useq</span> helper was added.  Then, the explicitly
verbose <span class="docutils literal">usev</span> variant added, and finally <span class="docutils literal">use</span> was made quiet
by default.  Same changes were applied to <span class="docutils literal">has</span>.</p>
<p>Fast forward to EAPI 7, we still have three variants of <span class="docutils literal">use</span>
and three variants of <span class="docutils literal">has</span>.  The base variant that is quiet,
the <span class="docutils literal">useq</span>/<span class="docutils literal">hasq</span> variant that is equivalent to the base variant
and the verbose <span class="docutils literal">usev</span>/<span class="docutils literal">hasv</span> variant.</p>
<p>In 2011, Portage already started warning about <span class="docutils literal">hasq</span> and <span class="docutils literal">useq</span>
being deprecated.  After adding the second argumen to <a class="reference internal" href="#usev">usev</a> in EAPI 8,
we have noticed that we cannot do the same to <span class="docutils literal">hasv</span>, and at the same
time that it was not used a single time in ::gentoo.  Therefore, we have
decided to remove it and have picked up <span class="docutils literal">hasq</span> and <span class="docutils literal">useq</span> along with
it.</p>
</section>
<section id="unpack-removes-support-for-7-zip-lha-and-rar-formats">
<span id="unpack"></span><h3><a class="toc-backref" href="#id22">unpack removes support for 7-Zip, LHA and RAR formats</a></h3>
<p>In EAPI 8, we have decided to remove the support for the least commonly
used archive formats from <span class="docutils literal">unpack</span>.  This meant:</p>
<ul class="simple">
<li><p>7-Zip (.7z) — used by 5 packages at the time of writing</p></li>
<li><p>LHA (.lha, .lzh) — not used at all</p></li>
<li><p>RAR (.rar) — used by 5 packages</p></li>
</ul>
<p>Packages using these format for distfiles must now unpack them manually.
We recommend using <span class="docutils literal">unpacker.eclass</span> for that.</p>
<p>Our goal is for PMS to specify the support for the most commonly used
archive formats, while everything else would be supported
via <span class="docutils literal">unpacker.eclass</span>.  The latter provides greater flexibility,
in particular making it possible to easily add support for alternative
unpackers (e.g. we could use 7-Zip to unpack RAR archives).</p>
</section>
</section>
<section id="retroactive-changes">
<h2><a class="toc-backref" href="#id23">Retroactive changes</a></h2>
<section id="properties-test-network-to-ease-reenabling-tests-requiring-internet">
<span id="test-network"></span><h3><a class="toc-backref" href="#id24">PROPERTIES=test_network to ease reenabling tests requiring Internet</a></h3>
<pre class="code bash literal-block"><code><span class="comment single"># Tests fail with network-sandbox, since they try to resolve google.com
</span><span class="name variable">PROPERTIES</span><span class="operator">=</span><span class="literal string double">&quot;test_network&quot;</span>
<span class="name variable">RESTRICT</span><span class="operator">=</span><span class="literal string double">&quot;test&quot;</span>

python_test<span class="operator">()</span> <span class="operator">{</span>
    <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">EPYTHON</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span> tests/tests.py -v <span class="operator">||</span> die
<span class="operator">}</span></code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>TL;DR: <span class="docutils literal">PROPERTIES=test_network</span> can now be used when it is really
impossible to provide meaningful testing without Internet access.</p>
</div>
<p>Ideally, we'd want all tests to work just fine without accessing
the Internet, either via mocks or spawning local servers.
Unfortunately, not all packages do that and in the end,
Internet-accessing tests are sometimes the only tests we can get.  While
we do not want to run such tests by default (and we do want
<span class="docutils literal"><span class="pre">FEATURES=network-sandbox</span></span> to protect us from uncontrolled Internet
access), it is valuable to be able to enable them in controlled
environments.</p>
<p>For this reason, we have decided to add a new <span class="docutils literal">PROPERTIES</span> value
<span class="docutils literal">test_network</span>.  It is supposed to be combined with <span class="docutils literal">RESTRICT=test</span>,
and it indicates that the tests are restricted precisely because they
need to access the Internet.  In the example above (taken from pycares),
all the package's tests require Internet access but otherwise they would
work just fine.</p>
<p>Now, old versions of package managers will just skip the tests because
of the test restriction.  However, the recent versions of Portage
include a new <span class="docutils literal">ALLOW_TEST</span> configuration variable (for <span class="docutils literal">make.conf</span>)
that can be used to elide test restriction.  If its value is set to
<span class="docutils literal">network</span>, then test restriction will be ignored and the tests will
be run on packages indicating <span class="docutils literal"><span class="pre">network-test</span></span>.  This makes it
an invaluable tool both for developers and arch testers.</p>
<p>This feature was originally proposed for EAPI 8 as a new <span class="docutils literal">RESTRICT</span>
value.  However, we have decided that it will be cleaner and more
convenient to combine with <span class="docutils literal">RESTRICT=test</span> and make an optional
extension for all EAPIs.</p>
<p>Note that this is primarily intended to be used on packages that do not
provide a meaningful subset of tests working without the Internet.
Whenever reasonable, it is still preferable to skip the tests accessing
the Internet and run the remainder of the test suite without adding
the test restriction in the first place.</p>
</section>
</section>
<section id="cheat-sheet-index">
<h2><a class="toc-backref" href="#id25">Cheat sheet / index</a></h2>
<p>The table following lists all the changes in a grep-for form that could
be used as a reference when upgrading ebuilds from EAPI 7 to EAPI 8.</p>
<blockquote>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 73%" />
</colgroup>
<thead>
<tr><th class="head"><p>Search term</p></th>
<th class="head"><p>Change</p></th>
</tr>
</thead>
<tbody>
<tr><td><p><a class="reference internal" href="#bash">bash</a></p></td>
<td><p>bash 5.0 is now sanctioned</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#datarootdir">--datarootdir</a></p></td>
<td><p>new econf-passed option</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#disable-static">--disable-static</a></p></td>
<td><p>new econf-passed option</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#doconfd">doconfd</a></p></td>
<td><p>no longer affected by <span class="docutils literal">insopts</span></p></td>
</tr>
<tr><td><p><a class="reference internal" href="#doenvd">doenvd</a></p></td>
<td><p>no longer affected by <span class="docutils literal">insopts</span></p></td>
</tr>
<tr><td><p><a class="reference internal" href="#doheader">doheader</a></p></td>
<td><p>no longer affected by <span class="docutils literal">insopts</span></p></td>
</tr>
<tr><td><p><a class="reference internal" href="#doinitd">doinitd</a></p></td>
<td><p>no longer affected by <span class="docutils literal">exeopts</span></p></td>
</tr>
<tr><td><p><a class="reference internal" href="#dosym-r">dosym -r</a></p></td>
<td><p>allows creating relative symlinks</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#fetch">fetch+</a></p></td>
<td><p><span class="docutils literal">SRC_URI</span> prefix to override fetch restriction</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#hasq">hasq</a></p></td>
<td><p>banned</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#hasv">hasv</a></p></td>
<td><p>banned</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#idepend">IDEPEND</a></p></td>
<td><p>new dependency type for <span class="docutils literal">pkg_postinst</span> deps</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#mirror">mirror+</a></p></td>
<td><p><span class="docutils literal">SRC_URI</span> prefix to override mirror restriction</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#patches">PATCHES</a></p></td>
<td><p>no longer permits specifying options (paths only)</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#properties">PROPERTIES</a></p></td>
<td><p>now accumulated across eclasses</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#restrict">RESTRICT</a></p></td>
<td><p>now accumulated across eclasses</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#test-network">test_network</a></p></td>
<td><p>new <span class="docutils literal">PROPERTIES</span> value for tests requiring Internet</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#unpack">unpack</a></p></td>
<td><p>no longer supports 7-Zip, LHA and RAR formats</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#updates">updates</a></p></td>
<td><p>filenames no longer have to follow <span class="docutils literal"><span class="pre">nQ-yyyy</span></span> style</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#useq">useq</a></p></td>
<td><p>banned</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#usev">usev</a></p></td>
<td><p>accepts second argument to override output value</p></td>
</tr>
<tr><td><p><a class="reference internal" href="#working-directory">working directory</a></p></td>
<td><p><span class="docutils literal">pkg_*</span> phases now start in an empty directory</p></td>
</tr>
</tbody>
</table>
</blockquote>
</section>
<section id="references">
<h2><a class="toc-backref" href="#id26">References</a></h2>
<dl class="footnote brackets">
<dt class="label" id="qa-policy-static"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Gentoo Policy Guide, Installation of static
libraries
(<a class="reference external" href="https://projects.gentoo.org/qa/policy-guide/installed-files.html#pg0302">https://projects.gentoo.org/qa/policy-guide/installed-files.html#pg0302</a>)</p>
</dd>
<dt class="label" id="bash-expansion"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>Bash Reference Manual: Shell Parameter Expansion
(<a class="reference external" href="https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html">https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html</a>)</p>
</dd>
<dt class="label" id="bash-news"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>bash 5.0 (and earlier) release notes
(<a class="reference external" href="https://git.savannah.gnu.org/cgit/bash.git/tree/NEWS?h=bash-5.0">https://git.savannah.gnu.org/cgit/bash.git/tree/NEWS?h=bash-5.0</a>)</p>
</dd>
<dt class="label" id="packaging-preinst-fail"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p>dev-python/packaging with dev-python/future
- pkg_preinst(): ImportError: This package should not be accessible
on Python 3.
(<a class="reference external" href="https://bugs.gentoo.org/574002">https://bugs.gentoo.org/574002</a>)</p>
</dd>
</dl>
</section>
</main>
</body>
</html>
