<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<title>verify-sig by example</title>
<meta name="author" content="Michał Górny" />
<meta name="dcterms.date" content="2022-02-20" />
<meta name="dcterms.rights" content="https://creativecommons.org/licenses/by/4.0/" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/"/>
<style type="text/css">

/* Minimal style sheet for the HTML output of Docutils.                    */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: minimal.css 8642 2021-03-26 13:51:14Z milde $               */
/* :Copyright: © 2015 Günter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */

/* This CSS2.1_ stylesheet defines rules for Docutils elements without    */
/* HTML equivalent. It is required to make the document semantic visible. */
/*                                                                        */
/* .. _CSS2.1: http://www.w3.org/TR/CSS2                                  */
/* .. _validates: http://jigsaw.w3.org/css-validator/validator$link       */

/* titles */
p.topic-title,
p.admonition-title,
p.system-message-title {
  font-weight: bold;
}
p.sidebar-title,
p.rubric {
  font-weight: bold;
  font-size: larger;
}
p.rubric {
  color: maroon;
}
p.subtitle,
p.section-subtitle,
p.sidebar-subtitle {
  font-weight: bold;
  margin-top: -0.5em;
}
h1 + p.subtitle {
  font-size: 1.6em;
}
h2 + p.section-subtitle, a.toc-backref {
  color: black;
  text-decoration: none;
}

/* Warnings, Errors */
.system-messages h2,
.system-message-title,
span.problematic {
  color: red;
}

/* Inline Literals */
.docutils.literal {
  font-family: monospace;
  white-space: pre-wrap;
}
/* do not wrap at hyphens and similar: */
.literal > span.pre { white-space: nowrap; }

/* Lists */

/* compact and simple lists: no margin between items */
.simple  li, .simple  ul, .simple  ol,
.compact li, .compact ul, .compact ol,
.simple  > li p, dl.simple  > dd,
.compact > li p, dl.compact > dd {
  margin-top: 0;
  margin-bottom: 0;
}
/* Nested Paragraphs */
p:first-child { margin-top: 0; }
p:last-child { margin-bottom: 0; }
td > p, th > p { margin-bottom: 0; }

/* Table of Contents */
.topic.contents { margin: 0.5em 0; }
.topic.contents ul.auto-toc {
  list-style-type: none;
  padding-left: 1.5em;
}

/* Enumerated Lists */
ol.arabic     { list-style: decimal }
ol.loweralpha { list-style: lower-alpha }
ol.upperalpha { list-style: upper-alpha }
ol.lowerroman { list-style: lower-roman }
ol.upperroman { list-style: upper-roman }

/* Definition Lists and Derivatives */
dt .classifier { font-style: italic }
dt .classifier:before {
  font-style: normal;
  margin: 0.5em;
  content: ":";
}
/* Field Lists and similar */
/* bold field name, content starts on the same line */
dl.field-list > dt,
dl.option-list > dt,
dl.docinfo > dt,
dl.footnote > dt,
dl.citation > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.5em;
}
/* Offset for field content (corresponds to the --field-name-limit option) */
dl.field-list > dd,
dl.option-list > dd,
dl.docinfo > dd {
  margin-left:  9em; /* ca. 14 chars in the test examples, fit all Docinfo fields */
}
/* start field-body on a new line after long field names */
dl.field-list > dd > *:first-child,
dl.option-list > dd > *:first-child
{
  display: inline-block;
  width: 100%;
  margin: 0;
}
/* field names followed by a colon */
dl.field-list > dt:after,
dl.docinfo > dt:after {
  content: ":";
}

/* Bibliographic Fields (docinfo) */
dl.docinfo pre.address {
  font: inherit;
  margin: 0.5em 0;
}
dl.docinfo > dd.authors > p { margin: 0; }

/* Option Lists */
dl.option-list > dt { font-weight: normal; }
span.option { white-space: nowrap; }

/* Footnotes and Citations  */
dl.footnote.superscript > dd { margin-left: 1em; }
dl.footnote.brackets > dd { margin-left: 2em; }
dl.footnote > dt { font-weight: normal; }
a.footnote-reference.brackets:before,
dt.label > span.brackets:before { content: "["; }
a.footnote-reference.brackets:after,
dt.label > span.brackets:after { content: "]"; }
a.footnote-reference.superscript,
dl.footnote.superscript > dt.label {
  vertical-align: super;
  font-size: small;
}
dt.label > span.fn-backref {
  margin-left: 0.2em;
  font-weight: normal;
}
dt.label > span.fn-backref > a { font-style: italic; }

/* Alignment */
.align-left   {
  text-align: left;
  margin-right: auto;
}
.align-center {
  clear: both;
  text-align: center;
  margin-left: auto;
  margin-right: auto;
}
.align-right  {
  text-align: right;
  margin-left: auto;
}
.align-top    { vertical-align: top; }
.align-middle { vertical-align: middle; }
.align-bottom { vertical-align: bottom; }

/* reset inner alignment in figures and tables */
figure.align-left, figure.align-right,
table.align-left, table.align-center, table.align-right {
  text-align: inherit;
}

/* Text Blocks */
blockquote,
div.topic,
aside.topic {
  margin: 1em 2em;
}
.sidebar,
.admonition,
.system-message {
  border: thin solid;
  margin: 1em 2em;
  padding: 0.5em 1em;
}
.sidebar {
  width: 30%;
  max-width: 26em;
  float: right;
  clear: right;
}
div.line-block { display: block; }
div.line-block div.line-block, pre { margin-left: 2em; }

/* Code line numbers: dropped when copying text from the page */
pre.code .ln { display: none; }
pre.code code:before {
  content: attr(data-lineno); /* …, none) fallback not supported by any browser */
  color: gray;
}

/* Tables */
table {
  border-collapse: collapse;
}
td, th {
  border: thin solid silver;
  padding: 0 1ex;
}
.borderless td, .borderless th {
  border: 0;
  padding: 0;
  padding-right: 0.5em /* separate table cells */
}

table > caption {
  text-align: left;
  margin-top: 0.2em;
  margin-bottom: 0.2em;
}
table.captionbelow {
  caption-side: bottom;
}

/* Document Header and Footer */
header { border-bottom: 1px solid black; }
footer { border-top: 1px solid black; }

/* Images are block-level by default in Docutils */
/* New HTML5 block elements: set display for older browsers */
img, header, section, footer, aside, nav, main, article, figure, video {
  display: block;
}
/* inline images */
p img, p video, figure img, figure video {
  display: inline;
}

</style>
<style type="text/css">

/* CSS31_ style sheet for the output of Docutils HTML writers.             */
/* Rules for easy reading and pre-defined style variants.                  */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: plain.css 8636 2021-03-19 00:23:33Z milde $                                                               */
/* :Copyright: © 2015 Günter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */
/* .. _CSS3: http://www.w3.org/TR/CSS3                                     */


/* Document Structure */
/* ****************** */

/* "page layout" */
body {
  margin: 0;
  background-color: #dbdbdb;
}
main, footer, header {
  line-height:1.3;
  /* avoid long lines --> better reading */
  /* optimum is 45…75 characters/line <http://webtypography.net/2.1.2> */
  /* OTOH: lines should not be too short because of missing hyphenation, */
  max-width: 50rem;
  padding: 1px 2%; /* 1px on top avoids grey bar above title (mozilla) */
  margin: auto;
}
main {
  counter-reset: table figure;
  background-color: white;
}
footer, header {
  font-size: smaller;
  padding: 0.5em 2%;
  border: none;
}

/* Transitions */
hr.docutils {
  width: 80%;
  margin-top: 1em;
  margin-bottom: 1em;
  clear: both;
}

/* Paragraphs */

/* vertical space (parskip) */
p, ol, ul, dl, li, dd,
div.line-block,
div.topic,
table {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}
p:first-child { margin-top: 0; }
/* (:last-child is new in CSS 3) */
p:last-child  { margin-bottom: 0; }

h1, h2, h3, h4, h5, h6,
dl > dd {
  margin-bottom: 0.5em;
}

/* Lists */
/* ===== */

/* Separate list entries in compound lists */
dl > dd, ol > li,

/* Definition Lists */
/* Indent lists nested in definition lists */
/* (:only-child is new in CSS 3)           */
dd > ul:only-child, dd > ol:only-child { padding-left: 1em; }

/* Description Lists */
/* styled like in most dictionaries, encyclopedias etc. */
dl.description > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.5em;
}

/* Field Lists */

/* example for custom field-name width */
dl.field-list.narrow > dd {
  margin-left: 5em;
}
/* run-in: start field-body on same line after long field names */
dl.field-list.run-in > dd p {
  display: block;
}

/* Bibliographic Fields */

/* generally, bibliographic fields use special definition list dl.docinfo */
/* but dedication and abstract are placed into "topic" divs */
div.abstract p.topic-title {
  text-align: center;
}
div.dedication {
  margin: 2em 5em;
  text-align: center;
  font-style: italic;
}
div.dedication p.topic-title {
  font-style: normal;
}

/* Text Blocks */
/* =========== */

/* Literal Blocks */
pre.literal-block, pre.doctest-block,
pre.math, pre.code {
  font-family: monospace;
}

/* Block Quotes */
blockquote > table,
div.topic > table {
  margin-top: 0;
  margin-bottom: 0;
}
blockquote p.attribution,
div.topic p.attribution {
  text-align: right;
  margin-left: 20%;
}

/* Tables */
/* ====== */

/* th { vertical-align: bottom; } */

table tr { text-align: left; }

/* "booktabs" style (no vertical lines) */
table.booktabs {
  border: 0;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.booktabs * {
  border: 0;
}
table.booktabs th {
  border-bottom: thin solid;
}

/* numbered tables (counter defined in div.document) */
table.numbered > caption:before {
  counter-increment: table;
  content: "Table " counter(table) ": ";
  font-weight: bold;
}

/* Explicit Markup Blocks */
/* ====================== */

/* Footnotes and Citations */
/* ----------------------- */

/* line on the left */
dl.footnote {
  padding-left: 1ex;
  border-left: solid;
  border-left-width: thin;
}

/* Directives */
/* ---------- */

/* Body Elements */
/* ~~~~~~~~~~~~~ */

/* Images and Figures */

/* let content flow to the side of aligned images and figures */
figure.align-left,
img.align-left,
video.align-left,
object.align-left {
  clear: left;
  float: left;
  margin-right: 1em;
}
figure.align-right,
img.align-right,
video.align-right,
object.align-right {
  clear: right;
  float: right;
  margin-left: 1em;
}
/* Stop floating sidebars, images and figures */
h1, h2, h3, h4, footer, header { clear: both; }

/* Numbered figures */
figure.numbered > figcaption > p:before {
  counter-increment: figure;
  content: "Figure " counter(figure) ": ";
  font-weight: bold;
}

/* Admonitions and System Messages */
.caution p.admonition-title,
.attention p.admonition-title,
.danger p.admonition-title,
.error p.admonition-title,
.warning p.admonition-title,
div.error {
  color: red;
}

/* Sidebar */
/* Move right. In a layout with fixed margins, */
/* it can be moved into the margin.            */
aside.sidebar {
  width: 30%;
  max-width: 26em;
  margin-left: 1em;
  margin-right: -2%;
  background-color: #ffffee;
}

/* Code */
pre.code { padding: 0.7ex }
pre.code, code { background-color: #eeeeee }
/* basic highlighting: for a complete scheme, see */
/* http://docutils.sourceforge.net/sandbox/stylesheets/ */
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

/* Math */
/* styled separately (see math.css for math-output=HTML) */

/* Epigraph           */
/* Highlights         */
/* Pull-Quote         */
/* Compound Paragraph */
/* Container          */

/* Inline Markup */
/* ============= */

/* Inline Literals                                          */
/* possible values: normal, nowrap, pre, pre-wrap, pre-line */
/*   span.docutils.literal { white-space: pre-wrap; }       */

/* Hyperlink References */
a { text-decoration: none; }

/* External Targets       */
/*   span.target.external */
/* Internal Targets       */
/*   span.target.internal */
/* Footnote References    */
/*   a.footnote-reference */
/* Citation References    */
/*   a.citation-reference */

</style>
</head>
<body class="with-toc">
<main id="verify-sig-by-example">
<h1 class="title">verify-sig by example</h1>
<dl class="docinfo simple">
<dt class="author">Author</dt>
<dd class="author"><p>Michał Górny</p></dd>
<dt class="date">Date</dt>
<dd class="date">2022-02-20</dd>
<dt class="version">Version</dt>
<dd class="version">1.0</dd>
<dt class="copyright">Copyright</dt>
<dd class="copyright"><a class="reference external" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></dd>
</dl>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#introduction-to-verify-sig-eclass" id="id1">Introduction to verify-sig.eclass</a></p></li>
<li><p><a class="reference internal" href="#openpgp-signature-verification" id="id2">OpenPGP signature verification</a></p>
<ul>
<li><p><a class="reference internal" href="#prerequisite-an-openpgp-key-package" id="id3">Prerequisite: an OpenPGP key package</a></p></li>
<li><p><a class="reference internal" href="#verifying-detached-signatures" id="id4">Verifying detached signatures</a></p></li>
<li><p><a class="reference internal" href="#combination-of-signed-and-unsigned-files" id="id5">Combination of signed and unsigned files</a></p></li>
<li><p><a class="reference internal" href="#verifying-using-a-checksum-file-with-an-inline-signature" id="id6">Verifying using a checksum file with an inline signature</a></p></li>
<li><p><a class="reference internal" href="#verifying-using-a-checksum-file-with-a-detached-signature" id="id7">Verifying using a checksum file with a detached signature</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#other-signature-providers" id="id8">Other signature providers</a></p>
<ul>
<li><p><a class="reference internal" href="#enabling-other-signature-provider" id="id9">Enabling other signature provider</a></p></li>
<li><p><a class="reference internal" href="#using-signify-based-signatures" id="id10">Using signify-based signatures</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="introduction-to-verify-sig-eclass">
<h2><a class="toc-backref" href="#id1">Introduction to verify-sig.eclass</a></h2>
<p>The <span class="docutils literal"><span class="pre">verify-sig.eclass</span></span> provides logic to verify the <em>authenticity</em>
of distfiles using the signatures provided upstream.  It is meant
as an auxiliary mechanism that helps developers perform version bumps.
While it can be enabled and used by users, Manifests remain the primary
method of verifying distfiles.</p>
<p>While the eclass provides a few functions, the ebuilds rarely need
to use more than one of them.  For this reason, this document focuses
on providing example ebuilds for specific use cases.  The majority
of the eclass consumers are using OpenPGP (<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc4880">RFC 4880</a>) signatures,
and therefore OpenPGP is used as the baseline solution for examples.
The final section is dedicated to using other providers.</p>
</section>
<section id="openpgp-signature-verification">
<h2><a class="toc-backref" href="#id2">OpenPGP signature verification</a></h2>
<section id="prerequisite-an-openpgp-key-package">
<h3><a class="toc-backref" href="#id3">Prerequisite: an OpenPGP key package</a></h3>
<p>In order to be able to test OpenPGP signatures, the appropriate OpenPGP
public keys need to be available first.  These keys are normally
installed via a <span class="docutils literal"><span class="pre">sec-keys/openpgp-keys-*</span></span> package.</p>
<p>The purpose of such a package is to fetch one or more OpenPGP keys,
combine them into a single file and install it into
<span class="docutils literal"><span class="pre">/usr/share/openpgp-keys</span></span>.  The keys can use either the binary
or the ASCII-armored OpenPGP format.  Both formats permit multiple keys
to be trivially concatenated.</p>
<p>Ideally, the keys should be fetched from upstream website.  If upstream
does not host explicit key files, another source can be used: WKD URLs,
<a class="reference external" href="https://www.keybase.io/">keybase.io</a>, public keyserver URLs.  However, it needs to be noted that
for GnuPG to work correctly, the key needs to include UIDs.</p>
<p>The verify-sig mechanics do not provide any way to verify
the authenticity of installed OpenPGP keys.  The maintainer of the key
package is responsible for ensuring that the authentic keys are used.</p>
<p>Since these packages install key files only, normally they are added
with a complete set of stable keywords.</p>
<pre class="code bash literal-block"><code><span class="comment single"># Copyright 2022 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2
</span>
<span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">7</span>

<span class="name variable">DESCRIPTION</span><span class="operator">=</span><span class="literal string double">&quot;OpenPGP keys used to sign Django releases&quot;</span>
<span class="name variable">HOMEPAGE</span><span class="operator">=</span><span class="literal string double">&quot;https://www.djangoproject.com/download/&quot;</span>
<span class="name variable">SRC_URI</span><span class="operator">=</span><span class="literal string double">&quot;
    https://keys.openpgp.org/vks/v1/by-fingerprint/FE5FB63876A1D718A8C67556E17DF5C82B4F9D00
        -&gt; FE5FB63876A1D718A8C67556E17DF5C82B4F9D00.asc
    https://keybase.io/felixx/pgp_keys.asc?fingerprint=abb2c2a8cd01f1613618b70d2ef56372ba48cd1b
        -&gt; ABB2C2A8CD01F1613618B70D2EF56372BA48CD1B.asc
&quot;</span>
<span class="name variable">S</span><span class="operator">=</span><span class="literal string interpol">${</span><span class="name variable">WORKDIR</span><span class="literal string interpol">}</span>

<span class="name variable">LICENSE</span><span class="operator">=</span><span class="literal string double">&quot;public-domain&quot;</span>
<span class="name variable">SLOT</span><span class="operator">=</span><span class="literal string double">&quot;0&quot;</span>
<span class="name variable">KEYWORDS</span><span class="operator">=</span><span class="literal string double">&quot;~alpha amd64 arm arm64 hppa ~ia64 ~m68k ~mips ppc ppc64 ~riscv ~s390 sparc x86&quot;</span>

src_install<span class="operator">()</span> <span class="operator">{</span>
    <span class="name builtin">local</span> <span class="name variable">files</span><span class="operator">=(</span> <span class="literal string interpol">${</span><span class="name variable">A</span><span class="literal string interpol">}</span> <span class="operator">)</span>
    insinto /usr/share/openpgp-keys
    newins - django.asc &lt; &lt;<span class="operator">(</span>cat <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">files</span><span class="punctuation">[&#64;]/#/</span><span class="literal string interpol">${</span><span class="name variable">DISTDIR</span><span class="literal string interpol">}</span><span class="punctuation">/</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">)</span>
<span class="operator">}</span></code></pre>
</section>
<section id="verifying-detached-signatures">
<h3><a class="toc-backref" href="#id4">Verifying detached signatures</a></h3>
<p>Detached signatures are separate files, usually suffixed <span class="docutils literal">.asc</span> or
<span class="docutils literal">.sig</span> that contain signatures for the respective distfiles.</p>
<p>To verify package using detached signatures, the ebuild needs to:</p>
<ol class="arabic simple">
<li><p>Add the signature files to <span class="docutils literal">SRC_URI</span>.</p></li>
<li><p>Add the package providing the public key to <span class="docutils literal">BDEPEND</span>.</p></li>
<li><p>Specify the key file to use via <span class="docutils literal">VERIFY_SIG_OPENPGP_KEY_PATH</span>.</p></li>
</ol>
<p>The <span class="docutils literal">src_unpack</span> implementation exported by the eclass takes care
of adding a <span class="docutils literal"><span class="pre">verify-sig</span></span> USE flag and verifying all files
from <span class="docutils literal">SRC_URI</span> when it is enabled.</p>
<pre class="code bash literal-block"><code><span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">8</span>

inherit verify-sig

<span class="name variable">SRC_URI</span><span class="operator">=</span><span class="literal string double">&quot;
    https://libvirt.org/sources/</span><span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span><span class="literal string double">.tar.xz
    verify-sig? ( https://libvirt.org/sources/</span><span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span><span class="literal string double">.tar.xz.asc )
&quot;</span>

<span class="name variable">BDEPEND</span><span class="operator">=</span><span class="literal string double">&quot;
    verify-sig? ( sec-keys/openpgp-keys-libvirt )
&quot;</span>

<span class="name variable">VERIFY_SIG_OPENPGP_KEY_PATH</span><span class="operator">=</span><span class="literal string interpol">${</span><span class="name variable">BROOT</span><span class="literal string interpol">}</span>/usr/share/openpgp-keys/libvirt.org.asc</code></pre>
</section>
<section id="combination-of-signed-and-unsigned-files">
<h3><a class="toc-backref" href="#id5">Combination of signed and unsigned files</a></h3>
<p>The default implementation of <span class="docutils literal">src_unpack</span> requires all distfiles
to be accompanied by detached signatures.  When some of the distfiles
(e.g. Gentoo patchsets) are not PGP-signed, the ebuild needs to override
<span class="docutils literal">src_unpack</span> and call <span class="docutils literal"><span class="pre">verify-sig_verify_detached</span></span> explicitly
for all files that need to be verified.</p>
<p>The function's synopsis is:</p>
<pre class="literal-block">verify-sig_verify_detached &lt;file&gt; &lt;signature-file&gt; [&lt;key&gt;]</pre>
<p><em>File</em> is the file to verify, <em>signature-file</em> is the file containing
the detached signature, <em>key</em> is the public key file.  If <em>key</em> is not
specified, <span class="docutils literal">VERIFY_SIG_OPENPGP_KEY_PATH</span> is used.</p>
<pre class="code bash literal-block"><code><span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">8</span>

inherit verify-sig

<span class="name variable">SRC_URI</span><span class="operator">=</span><span class="literal string double">&quot;
    https://www.python.org/ftp/python/</span><span class="literal string interpol">${</span><span class="name variable">PV</span><span class="punctuation">%%_*</span><span class="literal string interpol">}</span><span class="literal string double">/</span><span class="literal string interpol">${</span><span class="name variable">MY_P</span><span class="literal string interpol">}</span><span class="literal string double">.tar.xz
    https://dev.gentoo.org/~mgorny/dist/python/</span><span class="literal string interpol">${</span><span class="name variable">PATCHSET</span><span class="literal string interpol">}</span><span class="literal string double">.tar.xz
    verify-sig? (
        https://www.python.org/ftp/python/</span><span class="literal string interpol">${</span><span class="name variable">PV</span><span class="punctuation">%%_*</span><span class="literal string interpol">}</span><span class="literal string double">/</span><span class="literal string interpol">${</span><span class="name variable">MY_P</span><span class="literal string interpol">}</span><span class="literal string double">.tar.xz.asc
    )
&quot;</span>

<span class="name variable">BDEPEND</span><span class="operator">=</span><span class="literal string double">&quot;
    verify-sig? ( sec-keys/openpgp-keys-python )
&quot;</span>

<span class="name variable">VERIFY_SIG_OPENPGP_KEY_PATH</span><span class="operator">=</span><span class="literal string interpol">${</span><span class="name variable">BROOT</span><span class="literal string interpol">}</span>/usr/share/openpgp-keys/python.org.asc

src_unpack<span class="operator">()</span> <span class="operator">{</span>
    <span class="keyword">if</span> use verify-sig<span class="punctuation">;</span> <span class="keyword">then</span>
        verify-sig_verify_detached <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">DISTDIR</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>/<span class="literal string interpol">${</span><span class="name variable">MY_P</span><span class="literal string interpol">}</span>.tar.xz<span class="operator">{</span>,.asc<span class="operator">}</span>
    <span class="keyword">fi</span>
    default
<span class="operator">}</span></code></pre>
</section>
<section id="verifying-using-a-checksum-file-with-an-inline-signature">
<h3><a class="toc-backref" href="#id6">Verifying using a checksum file with an inline signature</a></h3>
<p>Rather than signing individual distfiles, some projects instead supply
a signed checksum file.  The hashes contained in this file can be used
to verify the <em>integrity</em> of distfiles.  However, if the checksum file
itself is signed, it can be used to assert the <em>authenticity</em>
of distfiles as well.</p>
<p>An example checksum file with multiple algorithms and an inline
signature follows:</p>
<pre class="code literal-block"><code>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

[...]

MD5 checksums
=============

a86339c0e87241597afa8744704d9965  Django-4.0.2.tar.gz
81bb12a26b4c2081ca491c4902bddef9  Django-4.0.2-py3-none-any.whl

SHA1 checksums
==============

b671dd5cb40814abb89953ce63db872036a7fb77  Django-4.0.2.tar.gz
163fa6da31e4f191ad06b749093703e019b30768  Django-4.0.2-py3-none-any.whl

SHA256 checksums
================

110fb58fb12eca59e072ad59fc42d771cd642dd7a2f2416582aa9da7a8ef954a  Django-4.0.2.tar.gz
996495c58bff749232426c88726d8cd38d24c94d7c1d80835aafffa9bc52985a  Django-4.0.2-py3-none-any.whl
-----BEGIN PGP SIGNATURE-----

iQJPBAEBCAA5FiEEq7LCqM0B8WE2GLcNLvVjcrpIzRsFAmH42nMbHGZlbGlzaWFr
[...]
-----END PGP SIGNATURE-----</code></pre>
<p>The <span class="docutils literal"><span class="pre">verify-sig_verify_signed_checksums</span></span> can be used to verify
the distfiles against this file.  Its synopsis is:</p>
<pre class="literal-block">verify-sig_verify_signed_checksums &lt;checksum-file&gt; &lt;algo&gt; &lt;files&gt; [&lt;key&gt;]</pre>
<p><em>Checksum file</em> specifies the file with the signatures.  <em>Algo</em>
specifies the signature algorithm used.  <em>Files</em> is a space-separated
list (passed as a single argument, i.e. quoted) of files to verify.
As before, <em>key</em> specifies the key file and defaults
to <span class="docutils literal">VERIFY_SIG_OPENPGP_KEY_PATH</span>.</p>
<p>The checksum file must contain a valid inline signature.  Only data
covered by the signature is processed.  Lines that do not resemble
checksums in the specified algorithm are ignored.  The checksum file
can also contain checksums using other algorithms, as long as they are
of different length than the one that is being tested.</p>
<p>For verification to succeed, all specified <em>files</em> must be present
in the checksum file and have matching hashes.  The file paths must
match exactly, therefore normally it is necessary to ensure that they
are present in the current working directory.</p>
<pre class="code bash literal-block"><code><span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">8</span>

inherit verify-sig

<span class="name variable">SRC_URI</span><span class="operator">=</span><span class="literal string double">&quot;
    https://media.djangoproject.com/releases/</span><span class="keyword">$(</span>ver_cut <span class="literal number">1</span>-2<span class="keyword">)</span><span class="literal string double">/</span><span class="literal string interpol">${</span><span class="name variable">MY_P</span><span class="literal string interpol">}</span><span class="literal string double">.tar.gz
    verify-sig? ( https://media.djangoproject.com/pgp/</span><span class="literal string interpol">${</span><span class="name variable">MY_P</span><span class="literal string interpol">}</span><span class="literal string double">.checksum.txt )
&quot;</span>

<span class="name variable">BDEPEND</span><span class="operator">=</span><span class="literal string double">&quot;
    verify-sig? ( &gt;=sec-keys/openpgp-keys-django-20201201 )
&quot;</span>

<span class="name variable">VERIFY_SIG_OPENPGP_KEY_PATH</span><span class="operator">=</span><span class="literal string interpol">${</span><span class="name variable">BROOT</span><span class="literal string interpol">}</span>/usr/share/openpgp-keys/django.asc

src_unpack<span class="operator">()</span> <span class="operator">{</span>
    <span class="keyword">if</span> use verify-sig<span class="punctuation">;</span> <span class="keyword">then</span>
        <span class="name builtin">cd</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">DISTDIR</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span> <span class="operator">||</span> die
        verify-sig_verify_signed_checksums <span class="literal string escape">\
</span>            <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">MY_P</span><span class="literal string interpol">}</span><span class="literal string double">.checksum.txt&quot;</span> sha256 <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">MY_P</span><span class="literal string interpol">}</span><span class="literal string double">.tar.gz&quot;</span>
        <span class="name builtin">cd</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">WORKDIR</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span> <span class="operator">||</span> die
    <span class="keyword">fi</span>

    default
<span class="operator">}</span></code></pre>
</section>
<section id="verifying-using-a-checksum-file-with-a-detached-signature">
<h3><a class="toc-backref" href="#id7">Verifying using a checksum file with a detached signature</a></h3>
<p>The final variant supported by the eclass is a checksum file that is
signed using a detached signature.  In this case the checksum file
contains only file hashes, and there is an additional <span class="docutils literal">.asc</span>-
or <span class="docutils literal">.sig</span>-suffixed file with the OpenPGP signature.  An example
checksum file could look like:</p>
<pre class="code literal-block"><code>94ccd60e04e558f33be73032bc84ea241660f92f58cfb88789bda6893739e31c tor-0.4.6.10.tar.gz</code></pre>
<p>This is similar to the previous variant, except that the ebuilds need
to explicitly perform two operations:</p>
<ol class="arabic simple">
<li><p>Verify the checksum file against the detached signature.  This is
done using <span class="docutils literal"><span class="pre">verify-sig_verify_detached</span></span> as with detached distfile
signatures.</p></li>
<li><p>Verify the distfiles against the checksum file.  This is done using
<span class="docutils literal"><span class="pre">verify-sig_verify_unsigned_checksums</span></span>.</p></li>
</ol>
<p>the <span class="docutils literal"><span class="pre">verify-sig_verify_unsigned_checksums</span></span> has the following
synopsis:</p>
<pre class="literal-block">verify-sig_verify_unsigned_checksums &lt;checksum-file&gt; &lt;algo&gt; &lt;files&gt;</pre>
<p><em>Checksum file</em> specifies the file with the signatures.  <em>Algo</em>
specifies the signature algorithm used.  <em>Files</em> is a space-separated
list (passed as a single argument, i.e. quoted) of files to verify.</p>
<pre class="code bash literal-block"><code><span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">8</span>

inherit verify-sig

<span class="name variable">SRC_URI</span><span class="operator">=</span><span class="literal string double">&quot;
    https://www.torproject.org/dist/</span><span class="literal string interpol">${</span><span class="name variable">MY_PF</span><span class="literal string interpol">}</span><span class="literal string double">.tar.gz
    verify-sig? (
        https://dist.torproject.org/</span><span class="literal string interpol">${</span><span class="name variable">MY_PF</span><span class="literal string interpol">}</span><span class="literal string double">.tar.gz.sha256sum
        https://dist.torproject.org/</span><span class="literal string interpol">${</span><span class="name variable">MY_PF</span><span class="literal string interpol">}</span><span class="literal string double">.tar.gz.sha256sum.asc
    )
&quot;</span>

<span class="name variable">BDEPEND</span><span class="operator">=</span><span class="literal string double">&quot;verify-sig? ( &gt;=sec-keys/openpgp-keys-tor-20220216 )&quot;</span>

<span class="name variable">VERIFY_SIG_OPENPGP_KEY_PATH</span><span class="operator">=</span><span class="literal string interpol">${</span><span class="name variable">BROOT</span><span class="literal string interpol">}</span>/usr/share/openpgp-keys/torproject.org.asc

src_unpack<span class="operator">()</span> <span class="operator">{</span>
    <span class="keyword">if</span> use verify-sig<span class="punctuation">;</span> <span class="keyword">then</span>
        <span class="name builtin">cd</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">DISTDIR</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span> <span class="operator">||</span> die
        verify-sig_verify_detached <span class="literal string interpol">${</span><span class="name variable">MY_PF</span><span class="literal string interpol">}</span>.tar.gz.sha256sum<span class="operator">{</span>,.asc<span class="operator">}</span>
        verify-sig_verify_unsigned_checksums <span class="literal string escape">\
</span>            <span class="literal string interpol">${</span><span class="name variable">MY_PF</span><span class="literal string interpol">}</span>.tar.gz.sha256sum sha256 <span class="literal string interpol">${</span><span class="name variable">MY_PF</span><span class="literal string interpol">}</span>.tar.gz
        <span class="name builtin">cd</span> <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">WORKDIR</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span> <span class="operator">||</span> die
    <span class="keyword">fi</span>

    default
<span class="operator">}</span></code></pre>
</section>
</section>
<section id="other-signature-providers">
<h2><a class="toc-backref" href="#id8">Other signature providers</a></h2>
<section id="enabling-other-signature-provider">
<h3><a class="toc-backref" href="#id9">Enabling other signature provider</a></h3>
<p>The signature provider used by the eclass can be configured using
the <span class="docutils literal">VERIFY_SIG_METHOD</span> variable.  This variable needs to be set
before inheriting the eclass to ensure that correct dependencies are
generated.</p>
<p>The eclass exposes the same API for all signature providers.  However,
not all providers are guaranteed support (or require) all the functions.
For historical reasons, some variables mention OpenPGP but are also
used with other providers, e.g. <span class="docutils literal">VERIFY_SIG_OPENPGP_KEY_PATH</span>
specifies the key path for any provider.</p>
</section>
<section id="using-signify-based-signatures">
<h3><a class="toc-backref" href="#id10">Using signify-based signatures</a></h3>
<p><a class="reference external" href="https://flak.tedunangst.com/post/signify">Signify</a> is the tool used to sign OpenBSD releases.  For signify-based
signatures:</p>
<ol class="arabic simple">
<li><p><span class="docutils literal">VERIFY_SIG_METHOD</span> needs to be set to <span class="docutils literal">signify</span>.</p></li>
<li><p>Keys are packaged as <span class="docutils literal"><span class="pre">sec-keys/signify-keys-*</span></span> and installed
into <span class="docutils literal"><span class="pre">/usr/share/signify-keys</span></span>.</p></li>
<li><p>Keys are usually rotated upstream, it therefore usually makes sense
to add a revision to the filename and slot the package.</p></li>
<li><p>The tool does not deal with symlinks used in <span class="docutils literal">DISTDIR</span> well,
so the files need to be copied elsewhere before the verification.</p></li>
</ol>
<p>An example signify key package follows.</p>
<pre class="code bash literal-block"><code><span class="comment single"># Copyright 2022 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2
</span>
<span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">8</span>

<span class="name variable">EGIT_COMMIT</span><span class="operator">=</span>cb113fe442f84ab7d4ac95b44c49812001e32350
<span class="name variable">MY_P</span><span class="operator">=</span><span class="literal string interpol">${</span><span class="name variable">P</span><span class="punctuation">#signify-keys-</span><span class="literal string interpol">}</span>
<span class="name variable">DESCRIPTION</span><span class="operator">=</span><span class="literal string double">&quot;Signify keys used to sign signify portable releases&quot;</span>
<span class="name variable">HOMEPAGE</span><span class="operator">=</span><span class="literal string double">&quot;https://github.com/aperezdc/signify&quot;</span>
<span class="name variable">SRC_URI</span><span class="operator">=</span><span class="literal string double">&quot;
    https://github.com/aperezdc/signify/raw/</span><span class="literal string interpol">${</span><span class="name variable">EGIT_COMMIT</span><span class="literal string interpol">}</span><span class="literal string double">/keys/signifyportable.pub
        -&gt; </span><span class="literal string interpol">${</span><span class="name variable">MY_P</span><span class="literal string interpol">}</span><span class="literal string double">.pub
&quot;</span>
<span class="name variable">S</span><span class="operator">=</span><span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">WORKDIR</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>

<span class="name variable">LICENSE</span><span class="operator">=</span><span class="literal string double">&quot;public-domain&quot;</span>
<span class="name variable">SLOT</span><span class="operator">=</span><span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">PV</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>
<span class="name variable">KEYWORDS</span><span class="operator">=</span><span class="literal string double">&quot;~alpha amd64 arm arm64 hppa ~ia64 ~m68k ~mips ppc ppc64 ~riscv ~s390 sparc x86&quot;</span>

src_install<span class="operator">()</span> <span class="operator">{</span>
    insinto /usr/share/signify-keys
    doins <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">DISTDIR</span><span class="literal string interpol">}</span><span class="literal string double">/</span><span class="literal string interpol">${</span><span class="name variable">MY_P</span><span class="literal string interpol">}</span><span class="literal string double">.pub&quot;</span>
<span class="operator">}</span></code></pre>
<p>An example signed checksum file looks like the following:</p>
<pre class="code literal-block"><code>untrusted comment: verify with signifyportable.pub
RWRQFCY809DUoRjNsQeqNhEUJJ2/utG430CzFa1JNu9J/CFPoqPP7RS69/feSTs0rkIbJpbHMauNmy6dac2aXePVeeBQn5EprQc=
SHA256 (signify-30.tar.xz) = f68406c3085ef902e85500e6c0b90e4c3f56347e5efffc0da7b6fb47803c8686</code></pre>
<p>An example package using signify-style signed checksums.</p>
<pre class="code bash literal-block"><code><span class="name variable">EAPI</span><span class="operator">=</span><span class="literal number">8</span>

<span class="name variable">VERIFY_SIG_METHOD</span><span class="operator">=</span><span class="literal string double">&quot;signify&quot;</span>
inherit verify-sig

<span class="name variable">SRC_URI</span><span class="operator">=</span><span class="literal string double">&quot;
    https://github.com/aperezdc/</span><span class="literal string interpol">${</span><span class="name variable">PN</span><span class="literal string interpol">}</span><span class="literal string double">/releases/download/v</span><span class="literal string interpol">${</span><span class="name variable">PV</span><span class="literal string interpol">}</span><span class="literal string double">/</span><span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span><span class="literal string double">.tar.xz
    verify-sig? (
        https://github.com/aperezdc/</span><span class="literal string interpol">${</span><span class="name variable">PN</span><span class="literal string interpol">}</span><span class="literal string double">/releases/download/v</span><span class="literal string interpol">${</span><span class="name variable">PV</span><span class="literal string interpol">}</span><span class="literal string double">/SHA256.sig
            -&gt; </span><span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span><span class="literal string double">.sha.sig
    )
&quot;</span>

<span class="name variable">BDEPEND</span><span class="operator">=</span><span class="literal string double">&quot;verify-sig? ( sec-keys/signify-keys-signify )&quot;</span>

<span class="name variable">VERIFY_SIG_OPENPGP_KEY_PATH</span><span class="operator">=</span><span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">BROOT</span><span class="literal string interpol">}</span><span class="literal string double">/usr/share/signify-keys/</span><span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span><span class="literal string double">.pub&quot;</span>

src_unpack<span class="operator">()</span> <span class="operator">{</span>
    <span class="keyword">if</span> use verify-sig<span class="punctuation">;</span> <span class="keyword">then</span>
        cp <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">DISTDIR</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span>/<span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span>.<span class="operator">{</span>sha.sig,tar.xz<span class="operator">}</span> . <span class="operator">||</span> die
        verify-sig_verify_signed_checksums <span class="literal string escape">\
</span>            <span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span>.sha.sig sha256 <span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span>.tar.xz
    <span class="keyword">fi</span>
    unpack <span class="literal string double">&quot;</span><span class="literal string interpol">${</span><span class="name variable">P</span><span class="literal string interpol">}</span><span class="literal string double">.tar.xz&quot;</span>
<span class="operator">}</span></code></pre>
</section>
</section>
</main>
</body>
</html>
